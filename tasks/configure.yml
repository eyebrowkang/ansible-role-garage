---
- name: Deploy Garage configuration file
  ansible.builtin.template:
    src: "{{ garage_config_template }}"
    dest: "{{ garage_config_dir }}/garage.toml"
    owner: root
    group: "{{ garage_group }}"
    mode: "0640"
  notify: Restart garage
  no_log: true

- name: Deploy environment file
  ansible.builtin.copy:
    content: |
      # Managed by Ansible
      {% for key, value in garage_env_variables | default({}, true) | dictsort %}
      {{ key }}={{ value | to_json }}
      {% endfor %}
    dest: "{{ garage_config_dir }}/garage.env"
    owner: root
    group: "{{ garage_group }}"
    mode: "0640"
  when: garage_env_variables | default({}, true) | length > 0
  notify: Restart garage
  no_log: true

- name: Remove environment file when no variables are set
  ansible.builtin.file:
    path: "{{ garage_config_dir }}/garage.env"
    state: absent
  when: garage_env_variables | default({}, true) | length == 0

- name: Deploy systemd service file
  ansible.builtin.template:
    src: garage.service.j2
    dest: /etc/systemd/system/garage.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart garage
