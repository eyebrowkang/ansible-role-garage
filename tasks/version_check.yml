---
- name: Get current installed Garage version
  ansible.builtin.command:
    cmd: "{{ garage_binary_path }} --version"
  register: _garage_current_version_output
  changed_when: false
  failed_when: false

- name: Parse current version
  ansible.builtin.set_fact:
    _garage_current_version: >-
      v{{ _garage_current_version_output.stdout | regex_search('(\d+\.\d+\.\d+)') }}
  when: _garage_current_version_output.rc == 0

- name: Display version information
  ansible.builtin.debug:
    msg: "Current: {{ _garage_current_version | default('not installed') }} -> Target: {{ garage_version }}"

- name: Parse target major version
  ansible.builtin.set_fact:
    _garage_target_major: "{{ (garage_version | regex_search('^v(\\d+)')) | int }}"

- name: Parse current major version
  ansible.builtin.set_fact:
    _garage_current_major: "{{ (_garage_current_version | regex_search('^v(\\d+)')) | int }}"
  when: _garage_current_version_output.rc == 0

- name: Fail if major version upgrade is attempted
  ansible.builtin.fail:
    msg: >-
      Major version upgrade detected (current {{ _garage_current_version }}
      -> target {{ garage_version }}). Please follow the official Garage upgrade
      guide and upgrade manually instead of using this role.
  when:
    - _garage_current_version_output.rc == 0
    - _garage_current_major < _garage_target_major

- name: Set install needed fact (binary not found)
  ansible.builtin.set_fact:
    _garage_install_needed: true
    _garage_upgrade_needed: false
  when: _garage_current_version_output.rc != 0

- name: Set install needed fact (binary found)
  ansible.builtin.set_fact:
    _garage_install_needed: false
  when: _garage_current_version_output.rc == 0

- name: Set upgrade needed fact (version comparison)
  when: _garage_current_version_output.rc == 0
  block:
    - name: Fail if downgrade attempted
      ansible.builtin.fail:
        msg: >-
          Downgrade not supported: current version {{ _garage_current_version }}
          is newer than target version {{ garage_version }}
      when: _garage_current_version is version(garage_version, '>')

    - name: Set upgrade needed when versions differ
      ansible.builtin.set_fact:
        _garage_upgrade_needed: "{{ _garage_current_version is version(garage_version, '<') }}"
