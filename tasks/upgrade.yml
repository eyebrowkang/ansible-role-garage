---
- name: Determine system architecture
  ansible.builtin.set_fact:
    _garage_arch: "{{ _garage_arch_map[ansible_architecture] | default('x86_64-unknown-linux-musl') }}"

- name: Compute effective checksum
  ansible.builtin.set_fact:
    _garage_effective_checksum: >-
      {%- set _raw = (garage_checksum if garage_checksum != ""
         else _garage_known_checksums[garage_version][_garage_arch]
              if garage_version in _garage_known_checksums
                 and _garage_arch in _garage_known_checksums[garage_version]
         else "") -%}
      {{ _raw if _raw == "" or ":" in _raw else "sha256:" ~ _raw }}

- name: Check Garage cluster status before upgrade
  ansible.builtin.command:
    cmd: "{{ garage_binary_path }} --config {{ garage_config_dir }}/garage.toml status"
  register: _garage_upgrade_status
  changed_when: false
  when: garage_upgrade_precheck | bool

- name: Run pre-upgrade repair (tables)
  ansible.builtin.command:
    cmd: "{{ garage_binary_path }} --config {{ garage_config_dir }}/garage.toml repair --all-nodes --yes tables"
  register: _garage_upgrade_repair
  changed_when: false
  when: garage_upgrade_precheck | bool

- name: Show repair workers
  ansible.builtin.command:
    cmd: "{{ garage_binary_path }} --config {{ garage_config_dir }}/garage.toml worker list"
  register: _garage_upgrade_workers
  changed_when: false
  when: garage_upgrade_precheck | bool

- name: Display repair workers output
  ansible.builtin.debug:
    msg: "{{ _garage_upgrade_workers.stdout | default('') }}"
  when: garage_upgrade_precheck | bool

- name: Stop Garage service before upgrade
  ansible.builtin.systemd_service:
    name: garage
    state: stopped
  failed_when: false

- name: Backup current Garage binary
  ansible.builtin.copy:
    src: "{{ garage_binary_path }}"
    dest: "{{ garage_binary_path }}.bak"
    remote_src: true
    mode: "0755"
  failed_when: false

- name: Download new Garage binary
  ansible.builtin.get_url:
    url: "https://garagehq.deuxfleurs.fr/_releases/{{ garage_version }}/{{ _garage_arch }}/garage"
    dest: "{{ garage_binary_path }}"
    checksum: "{{ _garage_effective_checksum | default(omit, true) }}"
    mode: "0755"
    owner: root
    group: root
    force: true
    timeout: 120
  notify: Restart garage
  retries: 3
  delay: 10
