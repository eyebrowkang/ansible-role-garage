---
- name: Check if Garage binary exists
  ansible.builtin.stat:
    path: "{{ garage_binary_path }}"
  register: _garage_binary

- name: Determine system architecture
  ansible.builtin.set_fact:
    _garage_arch: "{{ _garage_arch_map[ansible_architecture] | default('x86_64-unknown-linux-musl') }}"
  when: not _garage_binary.stat.exists

- name: Compute effective checksum
  ansible.builtin.set_fact:
    _garage_effective_checksum: >-
      {%- set _raw = (garage_checksum if garage_checksum != ""
         else _garage_known_checksums[garage_version][_garage_arch]
              if garage_version in _garage_known_checksums
                 and _garage_arch in _garage_known_checksums[garage_version]
         else "") -%}
      {{ _raw if _raw == "" or ":" in _raw else "sha256:" ~ _raw }}
  when: not _garage_binary.stat.exists

- name: Warn when no checksum is available for verification
  ansible.builtin.debug:
    msg: >-
      No checksum available for {{ garage_version }} ({{ _garage_arch }}).
      Binary will be downloaded without integrity verification.
      Set garage_checksum to provide a SHA256 checksum.
  when:
    - not _garage_binary.stat.exists
    - _garage_effective_checksum | default('') | trim == ''

- name: Download Garage binary
  ansible.builtin.get_url:
    url: "https://garagehq.deuxfleurs.fr/_releases/{{ garage_version }}/{{ _garage_arch }}/garage"
    dest: "{{ garage_binary_path }}"
    checksum: "{{ _garage_effective_checksum | default(omit, true) }}"
    mode: "0755"
    owner: root
    group: root
    timeout: 120
  when: not _garage_binary.stat.exists
  notify: Restart garage
  retries: 3
  delay: 10
