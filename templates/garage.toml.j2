# Managed by Ansible
# https://garagehq.deuxfleurs.fr/documentation/reference-manual/configuration/

replication_factor = {{ garage_replication_factor }}

metadata_dir = "{{ garage_metadata_dir }}"
{% if garage_data_dirs | default([]) | length > 0 %}
data_dir = [
{% for item in garage_data_dirs %}
  { path = "{{ item.path if item is mapping else item }}"{% if item is mapping and item.capacity is defined %}, capacity = "{{ item.capacity }}"{% endif %}{% if item is mapping and item.read_only is defined %}, read_only = {{ item.read_only | to_json }}{% endif %} }{% if not loop.last %},{% endif %}
{% endfor %}
]
{% else %}
data_dir = "{{ garage_data_dir }}"
{% endif %}

db_engine = "{{ garage_db_engine }}"

# RPC
{% if garage_rpc_secret_file | default('') | length > 0 %}
rpc_secret_file = "{{ garage_rpc_secret_file }}"
{% else %}
rpc_secret = "{{ garage_rpc_secret }}"
{% endif %}
rpc_bind_addr = "{{ garage_rpc_bind_addr }}"
{% if garage_rpc_public_addr | default('') | length > 0 %}
rpc_public_addr = "{{ garage_rpc_public_addr }}"
{% endif %}

{% if garage_bootstrap_peers | default([]) | length > 0 %}
bootstrap_peers = {{ garage_bootstrap_peers | to_json }}
{% endif %}

[s3_api]
api_bind_addr = "{{ garage_s3_api_bind_addr }}"
s3_region = "{{ garage_s3_region }}"
{% if garage_s3_root_domain | default('') | length > 0 %}
root_domain = "{{ garage_s3_root_domain }}"
{% endif %}

{% set _s3_web_enabled = (garage_s3_web_bind_addr | default('') | length > 0) and (garage_s3_web_root_domain | default('') | length > 0) %}
{% if _s3_web_enabled %}
[s3_web]
bind_addr = "{{ garage_s3_web_bind_addr }}"
root_domain = "{{ garage_s3_web_root_domain }}"
{% endif %}

[admin]
api_bind_addr = "{{ garage_admin_api_bind_addr }}"
{% if garage_admin_token_file | default('') | length > 0 %}
admin_token_file = "{{ garage_admin_token_file }}"
{% elif garage_admin_token | default('') | length > 0 %}
admin_token = "{{ garage_admin_token }}"
{% endif %}
{% if garage_metrics_token_file | default('') | length > 0 %}
metrics_token_file = "{{ garage_metrics_token_file }}"
{% elif garage_metrics_token | default('') | length > 0 %}
metrics_token = "{{ garage_metrics_token }}"
{% endif %}
